# Incident Response Playbook

This document provides step-by-step procedures for responding to security alerts generated by Proxilion MCP Security Gateway.

---

## Alert Severity Levels

| Decision | Threat Score | Severity | Response Time | Typical Causes |
|----------|--------------|----------|---------------|----------------|
| Allow | 0-49 | Info | No action | Normal operations |
| Alert | 50-69 | Low | 24 hours | Suspicious patterns, possible false positive |
| Block | 70-89 | Medium | 4 hours | Likely malicious activity |
| Terminate | 90-100 | Critical | 15 minutes | Confirmed attack, session killed |

---

## Immediate Response Procedures

### Critical (Score 90+, Session Terminated)

**Timeline: Respond within 15 minutes**

1. **Acknowledge the alert**
   - Log into monitoring system (Grafana/Prometheus)
   - Note the incident ID, user_id, session_id, timestamp

2. **Gather context**
   ```bash
   # Get recent logs for the user
   docker logs proxilion-gateway 2>&1 | grep "user_id\":\"USER_EMAIL" | tail -50

   # Check session history in Redis
   redis-cli HGETALL "session:SESSION_ID"
   ```

3. **Disable the user account**
   - Contact IT/Identity team immediately
   - Suspend user access in your identity provider (Okta, Azure AD, etc.)
   - Revoke any active API keys or tokens

4. **Preserve evidence**
   ```bash
   # Export relevant logs
   docker logs proxilion-gateway --since 1h > /tmp/incident-$(date +%s).log

   # Export Redis session data
   redis-cli HGETALL "session:SESSION_ID" > /tmp/session-evidence.txt
   ```

5. **Notify stakeholders**
   - Security team lead
   - User's manager
   - Legal/Compliance (if data breach suspected)
   - CISO (for score 95+)

6. **Begin investigation** (see Investigation Procedures below)

### Medium (Score 70-89, Blocked)

**Timeline: Respond within 4 hours**

1. **Review the alert**
   - Check patterns detected
   - Review the blocked tool call
   - Assess if this is a false positive

2. **Check user context**
   - Is this user in a security/DevOps role?
   - Were they performing authorized penetration testing?
   - Check recent communication (did they announce testing?)

3. **If legitimate work (false positive)**
   - Document the false positive
   - Consider threshold adjustment for this user role
   - Add to allowlist if appropriate

4. **If suspicious**
   - Review full session history
   - Check for earlier reconnaissance (lower-scored events)
   - Interview the user if needed
   - Escalate if patterns continue

### Low (Score 50-69, Alerted)

**Timeline: Review within 24 hours**

1. **Batch review**
   - Review alerts in daily/weekly security review
   - Look for patterns across users
   - Check for repeated alerts from same user

2. **Track trends**
   - Monitor alert frequency over time
   - Identify users with recurring alerts
   - Adjust thresholds if false positive rate is high

---

## Investigation Procedures

### Credential Harvesting Attempt

**Indicators:**
- Patterns: `.env file access`, `SSH key access`, `AWS credentials`, `/etc/shadow`
- Analyzer: `credential`, `file_access`

**Investigation Steps:**

1. **Identify what was accessed**
   ```bash
   # Check the tool call that triggered the alert
   grep "credential\|file_access" /var/log/proxilion/threats.log | grep "SESSION_ID"
   ```

2. **Determine scope**
   - What files were targeted?
   - Were any actually read before blocking?
   - Check if user has legitimate need for these files

3. **Check for prior reconnaissance**
   - Review session history for earlier `ls`, `find`, `cat` commands
   - Look for progressive access attempts

4. **Response actions**
   - If credentials may be compromised:
     - Rotate all potentially exposed credentials
     - Revoke and reissue SSH keys
     - Rotate API keys and tokens
   - Review access logs for those credentials
   - Check for unauthorized use

### Data Exfiltration Attempt

**Indicators:**
- Patterns: `curl to external IP`, `pastebin upload`, `netcat transfer`, `database dump`
- Analyzer: `exfiltration`, `data_volume`

**Investigation Steps:**

1. **Identify the target**
   ```bash
   # Check what data was being transferred
   grep "exfiltration" /var/log/proxilion/threats.log | grep "SESSION_ID"
   ```

2. **Determine if data left the network**
   - Was the transfer blocked before completion?
   - Check network logs for outbound connections
   - Review firewall logs

3. **Identify what data was targeted**
   - Database contents?
   - Source code?
   - Configuration files?
   - Customer data?

4. **Response actions**
   - If data may have been exfiltrated:
     - Engage legal/compliance for breach notification
     - Preserve all logs for forensics
     - Identify affected data subjects
   - Block destination IP/domain at firewall
   - Review data classification policies

### Network Reconnaissance

**Indicators:**
- Patterns: `nmap scan`, `port scanning`, `masscan`, `internal network range`
- Analyzer: `enumeration`, `hacking_tools`

**Investigation Steps:**

1. **Determine scan scope**
   - What IP ranges were targeted?
   - What ports were scanned?
   - Was this internal or external reconnaissance?

2. **Check for follow-up activity**
   - Did the user attempt to connect to discovered services?
   - Any credential access attempts after reconnaissance?
   - Session progression indicators?

3. **Response actions**
   - Document discovered assets (attacker now knows about them)
   - Review security of scanned systems
   - Consider if this was authorized security testing
   - If unauthorized: escalate and disable account

### Multi-Phase Attack Chain (Kill Chain)

**Indicators:**
- Session progression through: Reconnaissance -> Credential Access -> Exfiltration
- Multiple analyzer types triggered in sequence
- High correlation bonus in score

**Investigation Steps:**

1. **Map the full attack chain**
   ```bash
   # Get full session history
   redis-cli LRANGE "session:SESSION_ID:events" 0 -1
   ```

2. **Timeline reconstruction**
   - When did reconnaissance begin?
   - What credentials were targeted?
   - What data was the ultimate target?
   - How far did the attack progress?

3. **Assess damage**
   - What phase was blocked?
   - Did any phase complete successfully?
   - What access did attacker gain?

4. **Response actions**
   - Treat as confirmed incident
   - Engage incident response team
   - Full forensic investigation
   - Consider external forensics firm for major incidents

### Social Engineering (Conversation-Based)

**Indicators:**
- Patterns: `authority claim`, `roleplay manipulation`, `urgency pressure`
- Analyzer: `social_engineering`, `conversation_analysis`, `semantic`
- Requires conversation tracking enabled

**Investigation Steps:**

1. **Review the conversation history**
   - What claims did the user make?
   - Were they impersonating someone?
   - What were they trying to accomplish?

2. **Verify claims**
   - If claiming to be from security team, verify with security team
   - If claiming management approval, verify with management
   - If claiming urgency (audit, compliance), verify the deadline

3. **Response actions**
   - If impersonation confirmed: treat as insider threat
   - Report to HR and legal
   - Consider account compromise vs malicious insider

---

## Escalation Procedures

### Escalation Matrix

| Situation | Escalate To | Timeline |
|-----------|-------------|----------|
| Score 90+ | Security Lead, User's Manager | Immediate |
| Multiple blocks same user | Security Lead | Same day |
| Credential exfiltration suspected | CISO, Legal | Immediate |
| Customer data targeted | CISO, Legal, Privacy Officer | Immediate |
| Source code exfiltration | CISO, CTO, Legal | Immediate |
| Multiple users coordinated | CISO, Security Team | Immediate |
| Pattern across organization | CISO, Executive Team | Same day |

### Escalation Template

```
PROXILION SECURITY INCIDENT ESCALATION

Incident ID: [FROM ALERT]
Severity: [CRITICAL/HIGH/MEDIUM]
Time Detected: [TIMESTAMP]
User Affected: [USER_ID]

Summary:
[Brief description of what was detected]

Threat Score: [SCORE]
Patterns Detected:
- [PATTERN 1]
- [PATTERN 2]

Session Status: [ACTIVE/TERMINATED]
Blocked Actions: [YES/NO]

Immediate Actions Taken:
1. [ACTION]
2. [ACTION]

Recommended Next Steps:
1. [RECOMMENDATION]
2. [RECOMMENDATION]

Investigating Analyst: [YOUR NAME]
Contact: [YOUR CONTACT]
```

---

## Communication Templates

### User Notification (Blocked Action)

Subject: Security Alert - Action Blocked

```
Your recent action in [TOOL NAME] was blocked by our security system.

Action: [TOOL CALL DESCRIPTION]
Time: [TIMESTAMP]
Reason: [HIGH-LEVEL REASON]

If this was legitimate work, please contact the Security Team at [CONTACT]
with reference number [INCIDENT_ID].

If you did not perform this action, please contact Security immediately
as your account may be compromised.
```

### User Notification (Session Terminated)

Subject: URGENT: Security Incident - Session Terminated

```
Your session in [TOOL NAME] was terminated due to a security concern.

Time: [TIMESTAMP]
Reference: [INCIDENT_ID]

Please do NOT attempt to log back in until contacted by Security.

A member of the Security Team will contact you within [TIMEFRAME] to
discuss this incident.

If you believe this is an error, please call [SECURITY HOTLINE] immediately.
```

### Manager Notification

Subject: Security Incident Involving [EMPLOYEE NAME]

```
A security incident has been detected involving [EMPLOYEE NAME].

Incident Type: [TYPE]
Severity: [LEVEL]
Time: [TIMESTAMP]

Actions Taken:
- [ACTION 1]
- [ACTION 2]

Status: Under investigation

The Security Team will provide an update within [TIMEFRAME].

Please do not discuss this with the employee until Security has
completed initial investigation.

Contact: [SECURITY LEAD NAME] at [CONTACT]
```

---

## Post-Incident Procedures

### Immediate (Within 24 Hours)

1. **Document everything**
   - All actions taken
   - Timeline of events
   - Evidence collected
   - Communications sent

2. **Preserve evidence**
   - Export all relevant logs
   - Screenshot dashboards
   - Save Redis session data
   - Document chain of custody

3. **Initial report**
   - Brief summary for leadership
   - Scope of incident
   - Initial containment status

### Short-Term (Within 1 Week)

1. **Root cause analysis**
   - How did the attack start?
   - What controls failed?
   - What controls worked?

2. **Remediation**
   - Close any security gaps
   - Update detection rules if needed
   - Implement additional controls

3. **User disposition**
   - If account compromise: reset credentials, restore access
   - If malicious insider: HR/Legal action
   - If false positive: restore access, document lesson learned

### Long-Term (Within 1 Month)

1. **Lessons learned**
   - What can we improve?
   - Were response procedures effective?
   - Do we need additional tooling?

2. **Detection tuning**
   - Update Proxilion thresholds if needed
   - Add new patterns if attack was novel
   - Reduce false positive rate

3. **Process improvement**
   - Update this playbook
   - Update training materials
   - Consider tabletop exercises

---

## False Positive Handling

### Identifying False Positives

Common false positive scenarios:
- Security team performing authorized testing
- DevOps accessing production credentials for deployment
- Developers reading .env.example files
- Automated CI/CD pipelines
- Database administrators running maintenance dumps

### False Positive Workflow

1. **Verify legitimacy**
   - Contact the user
   - Verify the business need
   - Check authorization

2. **Document**
   - Record the false positive
   - Note the pattern that triggered
   - Record the legitimate use case

3. **Adjust (if appropriate)**
   - Add pattern to allowlist
   - Adjust score for specific user roles
   - Update analyzer configuration

4. **Track metrics**
   - Monitor false positive rate
   - Target: <5% of all alerts
   - Review monthly with security team

### Allowlist Request Process

1. User or manager submits request with:
   - Business justification
   - Specific pattern to allowlist
   - Duration (permanent or temporary)

2. Security team reviews:
   - Verify business need
   - Assess risk of allowlisting
   - Approve or deny with documentation

3. Implementation:
   - Update configuration
   - Test that allowlist works
   - Document in change log

---

## Metrics and Reporting

### Key Metrics to Track

| Metric | Target | Review Frequency |
|--------|--------|------------------|
| Mean time to acknowledge | <15 min (critical) | Weekly |
| Mean time to resolve | <4 hours (critical) | Weekly |
| False positive rate | <5% | Monthly |
| Incidents per week | Trending down | Weekly |
| Blocked vs terminated ratio | Monitor trend | Monthly |

### Weekly Security Report Template

```
PROXILION WEEKLY SECURITY REPORT
Week of [DATE]

Summary:
- Total requests analyzed: [COUNT]
- Alerts generated: [COUNT] ([PERCENT]%)
- Actions blocked: [COUNT]
- Sessions terminated: [COUNT]

Top Triggered Analyzers:
1. [ANALYZER] - [COUNT] times
2. [ANALYZER] - [COUNT] times
3. [ANALYZER] - [COUNT] times

Notable Incidents:
- [BRIEF DESCRIPTION]
- [BRIEF DESCRIPTION]

False Positives Identified: [COUNT]
Threshold Adjustments Made: [YES/NO]

Recommendations:
- [RECOMMENDATION]
```

---

## Contact Information

| Role | Contact | Availability |
|------|---------|--------------|
| Security Team Lead | [EMAIL/PHONE] | Business hours |
| Security On-Call | [EMAIL/PHONE] | 24/7 |
| CISO | [EMAIL/PHONE] | Business hours |
| Legal | [EMAIL/PHONE] | Business hours |
| HR | [EMAIL/PHONE] | Business hours |
| IT Help Desk | [EMAIL/PHONE] | Business hours |

**For Critical Incidents (Score 90+):**
1. Page Security On-Call immediately
2. Do not wait for email response
3. Use phone for urgent escalations

---

## Appendix: Analyzer Reference

| Analyzer | Detects | Typical Score Range |
|----------|---------|---------------------|
| enumeration | nmap, masscan, port scanning | 60-85 |
| credential | .env, SSH keys, AWS creds | 70-95 |
| exfiltration | curl uploads, pastebin, netcat | 75-95 |
| hacking_tools | metasploit, hashcat, mimikatz | 80-95 |
| privilege_escalation | sudo abuse, SUID | 65-85 |
| lateral_movement | SSH pivoting | 70-90 |
| persistence | cron, systemd backdoors | 75-90 |
| command_and_control | reverse shells, C2 beacons | 80-95 |
| impact | rm -rf, destructive ops | 85-95 |
| social_engineering | authority claims, manipulation | 50-80 |
| ai_velocity | automated execution | 60-85 |
| data_volume | bulk transfers | 65-85 |

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | [DATE] | [AUTHOR] | Initial version |

**Review Schedule:** Quarterly or after any major incident

**Owner:** Security Operations Team
